<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="https://ik.imagekit.io/khfpxrcgz/recycle-bin%20(1).png?updatedAt=1748088726617" />
  <title>BinTrack - Smart Dustbin Monitor</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <div class="sidebar">
    <div class="sidebar-header">
      <img src="https://ik.imagekit.io/khfpxrcgz/recycle-bin%20(1).png?updatedAt=1748088726617" alt="logo">
      <h2>BinTrack</h2>
    </div>
    <button onclick="showTab('grid-view')">Grid View</button>
    <button onclick="showTab('table-view')">Table View</button>
    <button onclick="showTab('map-view')">Map View</button>
    
  </div>

  <div class="content">
    <div class="rown">
      <img src="https://ik.imagekit.io/khfpxrcgz/recycle-bin%20(1).png?updatedAt=1748088726617" alt="logo">
      <h2>Smart Dustbin Monitor</h2>
    </div>

    <p class="intro">BinTrack helps you stay updated on bin status anytime.<br>
Cleaner cities start with smarter monitoring.</p>
    <div id="grid-view" class="tab-view active">
      <div class="grid">
        <!-- Dustbin cards -->
        <div class="dustbin-card">
          <img id="dustbin-img-001" src="https://ik.imagekit.io/khfpxrcgz/dustbin-green.png" alt="Dustbin">
          <div class="dustbin-id">001</div>
          <div class="dustbin-detail" id="dustbin-status-001">Loading...</div>
        </div>
        <div class="dustbin-card">
          <img id="dustbin-img-002" src="https://ik.imagekit.io/khfpxrcgz/dustbin-green.png?updatedAt=1748065493153" alt="Dustbin">
          <div class="dustbin-id">002</div>
          <div class="dustbin-detail" id="dustbin-status-002">Not Filled</div>
        </div>

        <div class="dustbin-card">
          <img id="dustbin-img-003" src="https://ik.imagekit.io/khfpxrcgz/dustbin-green.png?updatedAt=1748065493153" alt="Dustbin">
          <div class="dustbin-id">003</div>
          <div class="dustbin-detail" id="dustbin-status-003">Not Filled</div>
        </div>

        <div class="dustbin-card">
          <img id="dustbin-img-004" src="https://ik.imagekit.io/khfpxrcgz/dustbin-green.png?updatedAt=1748065493153" alt="Dustbin">
          <div class="dustbin-id">004</div>
          <div class="dustbin-detail" id="dustbin-status-004">Not Filled</div>
        </div>

        <div class="dustbin-card">
          <img  id="dustbin-img-005" src="https://ik.imagekit.io/khfpxrcgz/dustbin-green.png?updatedAt=1748065493153" alt="Dustbin">
          <div class="dustbin-id">005</div>
          <div class="dustbin-detail" id="dustbin-status-005">Not Filled</div>
        </div>

        <div class="dustbin-card">
          <img  id="dustbin-img-006" src="https://ik.imagekit.io/khfpxrcgz/dustbin-green.png?updatedAt=1748065493153" alt="Dustbin">
          <div class="dustbin-id">006</div>
          <div class="dustbin-detail" id="dustbin-status-006">Not Filled</div>
        </div>

        <div class="dustbin-card">
          <img id="dustbin-img-007" src="https://ik.imagekit.io/khfpxrcgz/dustbin-green.png?updatedAt=1748065493153" alt="Dustbin">
          <div class="dustbin-id">007</div>
          <div class="dustbin-detail" id="dustbin-status-007">Not Filled</div>
        </div>

        <div class="dustbin-card">
          <img id="dustbin-img-008" src="https://ik.imagekit.io/khfpxrcgz/dustbin-green.png?updatedAt=1748065493153" alt="Dustbin">
          <div class="dustbin-id">008</div>
          <div class="dustbin-detail" id="dustbin-status-008">Not Filled</div>
        </div>

        <div class="dustbin-card">
          <img id="dustbin-img-009" src="https://ik.imagekit.io/khfpxrcgz/dustbin-green.png?updatedAt=1748065493153" alt="Dustbin">
          <div class="dustbin-id">009</div>
          <div class="dustbin-detail" id="dustbin-status-009">Not Filled</div>
        </div>

        <div class="dustbin-card">
          <img id="dustbin-img-010" src="https://ik.imagekit.io/khfpxrcgz/dustbin-green.png?updatedAt=1748065493153" alt="Dustbin">
          <div class="dustbin-id">010</div>
          <div class="dustbin-detail" id="dustbin-status-010">Not Filled</div>
        </div>
      </div>
    </div>

    <div id="table-view" class="tab-view">
      <table>
        <thead>
          <tr>
            <th>Dustbin No</th>
            <th>Address</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>001</td>
            <td>My Classroom</td>
            <td id="table-status-001">Loading...</td>
          </tr>
          <tr>
            <td>002</td>
            <td>Canteen</td>
            <td id="table-status-002">Loading...</td>
          </tr>
          <tr>
            <td>003</td>
            <td>Parking 1</td>
            <td id="table-status-003">Loading...</td>
          </tr>
          <tr>
            <td>004</td>
            <td>Parking 2</td>
            <td id="table-status-004">Loading...</td>
          </tr>
          <tr>
            <td>005</td>
            <td>Boys Hostel</td>
            <td id="table-status-005">Loading...</td>
          </tr>
          <tr>
            <td>006</td>
            <td>Girls Hostel</td>
            <td id="table-status-006">Loading...</td>
          </tr>
          <tr>
            <td>007</td>
            <td>Caffe</td>
            <td id="table-status-007">Loading...</td>
          </tr>
          <tr>
            <td>008</td>
            <td>A Block</td>
            <td id="table-status-008">Loading...</td>
          </tr>
          <tr>
            <td>009</td>
            <td>B block</td>
            <td id="table-status-009">Loading...</td>
          </tr>
          <tr>
            <td>010</td>
            <td>C Block</td>
            <td id="table-status-010">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="map-view" class="tab-view">
      <div id="map"></div>
    </div>

  </div>

<script>
  function showTab(tabId) {
      document.querySelectorAll('.tab-view').forEach(tab => {
        tab.classList.remove('active');
      });
      document.getElementById(tabId).classList.add('active');

      if (tabId === "map-view") {
          setTimeout(() => initMap(), 200);
      }
  }
</script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-database-compat.js"></script>

<script>
  const greenBin = "https://ik.imagekit.io/khfpxrcgz/dustbin-green.png";
  const redBin = "https://ik.imagekit.io/khfpxrcgz/dustbin-red.png";

  // Truck fixed location
  const truckLocation = { lat: 10.88964, lng: 76.99225 };

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCzi2IsDsZE5WIA7KpDgS-0RFs6vxSDqDY",
    authDomain: "brave-design-417105.firebaseapp.com",
    databaseURL: "https://brave-design-417105-default-rtdb.firebaseio.com",
    projectId: "brave-design-417105",
    storageBucket: "brave-design-417105.appspot.com",
    messagingSenderId: "218139478751",
    appId: "1:218139478751:web:a8a36aeab810976906b76a"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let map;
  let markers = {};
  let dustbinLocations = {};

  let directionsService;
  let directionsRenderer;

  // UI update for dustbin 001
  db.ref("dustbins/001/filled").on("value", (snapshot) => {
    const filled = snapshot.val();

    document.getElementById("dustbin-status-001").textContent =
      filled ? "Filled" : "Not Filled";

    document.getElementById("dustbin-img-001").src =
      filled ? redBin : greenBin;

    document.getElementById("table-status-001").textContent =
      filled ? "Filled" : "Not Filled";

    document.getElementById("table-status-001").style.color =
      filled ? "red" : "green";
  });

  // Load full dustbin data
  db.ref("dustbins").on("value", (snapshot) => {
    const data = snapshot.val();
    dustbinLocations = data;

    updateMapMarkers();
    findNearestFilled();
  });

  // Add/redraw markers
  function updateMapMarkers() {
    Object.keys(dustbinLocations).forEach(id => {
      const d = dustbinLocations[id];

      if (markers[id]) markers[id].setMap(null);

      markers[id] = new google.maps.Marker({
        position: { lat: d.lat, lng: d.lng },
        map: map,
        title: `Dustbin ${id}`,
        icon: d.filled
          ? "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
          : "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
      });
    });
  }

  // Calculate nearest filled bin
  function findNearestFilled() {
    let nearest = null;
    let minDist = Infinity;

    Object.keys(dustbinLocations).forEach(id => {
      const d = dustbinLocations[id];
      if (!d.filled) return;

      const dist = google.maps.geometry.spherical.computeDistanceBetween(
        new google.maps.LatLng(truckLocation.lat, truckLocation.lng),
        new google.maps.LatLng(d.lat, d.lng)
      );

      if (dist < minDist) {
        minDist = dist;
        nearest = { id, ...d };
      }
    });

    if (nearest) {
      drawRouteToDustbin(nearest);
    }
  }

  // Draw route from truck â†’ dustbin
  function drawRouteToDustbin(dustbin) {
    if (!directionsService) {
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        map: map,
        suppressMarkers: true
      });
    }

    const request = {
      origin: truckLocation,
      destination: { lat: dustbin.lat, lng: dustbin.lng },
      travelMode: google.maps.TravelMode.DRIVING
    };

    directionsService.route(request, (result, status) => {
      if (status === "OK") {
        directionsRenderer.setDirections(result);
      }
    });
  }

  function getOptimizedRoute(filledBins) {
    const unvisited = [...filledBins];
    const ordered = [];

    let current = { lat: truckLocation.lat, lng: truckLocation.lng };

    while (unvisited.length > 0) {
        let nearestIndex = 0;
        let nearestDist = Infinity;

        unvisited.forEach((bin, index) => {
            const dist = google.maps.geometry.spherical.computeDistanceBetween(
                new google.maps.LatLng(current.lat, current.lng),
                new google.maps.LatLng(bin.lat, bin.lng)
            );

            if (dist < nearestDist) {
                nearestDist = dist;
                nearestIndex = index;
            }
        });

        const next = unvisited.splice(nearestIndex, 1)[0];
        ordered.push(next);
        current = { lat: next.lat, lng: next.lng };
    }

    return ordered;  // fully ordered nearest-neighbour path
}


function findRouteForAllFilled() {
    const filledBins = Object.keys(dustbinLocations)
        .map(id => ({ id, ...dustbinLocations[id] }))
        .filter(b => b.filled);

    if (filledBins.length === 0) return;

    const orderedBins = getOptimizedRoute(filledBins);
    drawFullRoute(orderedBins);
}

function drawFullRoute(orderedBins) {
    if (!directionsService) {
        directionsService = new google.maps.DirectionsService();
    }

    if (!directionsRenderer) {
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: false
        });
    }

    // Build waypoints: All bins
    const waypoints = orderedBins.map(bin => ({
        location: { lat: bin.lat, lng: bin.lng },
        stopover: true
    }));

    const request = {
        origin: truckLocation,                // START = TRUCK
        destination: truckLocation,           // END = TRUCK
        waypoints: waypoints,                 // All bins in between
        optimizeWaypoints: false,             // We already optimized
        travelMode: google.maps.TravelMode.DRIVING
    };

    directionsService.route(request, (result, status) => {
        if (status === "OK") {
            directionsRenderer.setDirections(result);
            displayOrder(orderedBins);
        } else {
            console.error("Routing failed:", status);
        }
    });
}

function displayOrder(orderedBins) {
    let msg = "Collection Order:\n";

    orderedBins.forEach((bin, index) => {
        msg += `${index + 1}. Dustbin ${bin.id}\n`;
    });

    console.log(msg); // shows in console
    alert(msg);       // popup window (you can change to UI element later)
}

  // Initialize map
  function initMap() {
    

    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 11.016, lng: 76.955 },
      zoom: 16,
    });

    new google.maps.Marker({
      position: truckLocation,
      map: map,
      icon: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
      title: "Truck"
    });

    directionsRenderer = new google.maps.DirectionsRenderer();
    directionsRenderer.setMap(map);
    
    updateMapMarkers();
    findRouteForAllFilled();

    
  }
</script>

<!-- ONLY ONE MAP SCRIPT (IMPORTANT) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBszl7IDU_I-hIJBVwSyAxrZXwpt23kyZg&libraries=geometry&callback=initMap" defer></script>

</body>
</html>
