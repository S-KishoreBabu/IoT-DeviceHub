<!DOCTYPE html>
<html>
<head>
  <title>BinTrack â€“ Smart Route Planner</title>
  <style>
    body { margin: 0; display: flex; height: 100vh; }
    #sidebar {
      width: 300px;
      background: #f5f5f5;
      padding: 15px;
      overflow-y: auto;
      border-right: 2px solid #ddd;
    }
    #map { flex: 1; }
    .bin-item {
      background: white;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
    }
  </style>
</head>

<body>

<div id="sidebar">
  <h2>ðŸ—‘ Filled Dustbins</h2>
  <p>Bins with 75% and above:</p>
  <div id="bin-list"></div>
</div>

<div id="map"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  // Firebase Config
  const firebaseConfig = {
   apiKey: "AIzaSyCzi2IsDsZE5WIA7KpDgS-0RFs6vxSDqDY",
    authDomain: "brave-design-417105.firebaseapp.com",
    databaseURL: "https://brave-design-417105-default-rtdb.firebaseio.com",
    projectId: "brave-design-417105",
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Google Map variables
  let map, directionsService, directionsRenderer;

  // Truck starting point (Garage)
  const truckStart = { lat: 11.0100, lng: 76.9500 };

  // Marker icons
  const icons = {
    green:  "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
    orange: "https://maps.google.com/mapfiles/ms/icons/orange-dot.png",
    red:    "https://maps.google.com/mapfiles/ms/icons/red-dot.png"
  };

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: truckStart,
      zoom: 13,
    });

    // Draw truck location
    new google.maps.Marker({
      position: truckStart,
      map,
      title: "Truck Start",
      icon: "https://maps.google.com/mapfiles/ms/icons/truck.png"
    });

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: false });
    directionsRenderer.setMap(map);

    watchDustbins(); // Auto-update route when Firebase changes
  }

  // Fetch + auto update from Firebase
  function watchDustbins() {
    db.ref("dustbins").on("value", snapshot => {
      const bins = snapshot.val();
      const filledBins = [];

      document.getElementById("bin-list").innerHTML = ""; // clear UI

      Object.keys(bins).forEach(id => {
        const b = bins[id];

        // marker color
        let markerColor =
          b.fill < 50 ? icons.green :
          b.fill < 75 ? icons.orange :
                        icons.red;

        // Draw marker
        new google.maps.Marker({
          position: { lat: b.lat, lng: b.lng },
          map,
          title: `Bin ${id} - ${b.fill}%`,
          icon: markerColor
        });

        // Only add bins >= 75%
        if (b.fill >= 75) {
          filledBins.push({ id, lat: b.lat, lng: b.lng, fill: b.fill });

          document.getElementById("bin-list").innerHTML += `
            <div class="bin-item">
              <span>Bin ${id}</span>
              <span>${b.fill}%</span>
            </div>`;
        }
      });

      if (filledBins.length > 0) {
        generateOptimizedRoute(filledBins);
      } else {
        directionsRenderer.setDirections({ routes: [] }); // clear route
      }
    });
  }

  function generateOptimizedRoute(locations) {
    const waypoints = locations.map(loc => ({
      location: new google.maps.LatLng(loc.lat, loc.lng),
      stopover: true
    }));

    directionsService.route({
      origin: truckStart,
      destination: truckStart,  // return back to garage
      waypoints: waypoints,
      optimizeWaypoints: true,
      travelMode: google.maps.TravelMode.DRIVING
    }, (response, status) => {
      if (status === "OK") {
        directionsRenderer.setDirections(response);
      } else {
        console.error("Route error:", status);
      }
    });
  }
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBszl7IDU_I-hIJBVwSyAxrZXwpt23kyZg&callback=initMap" async defer></script>

</body>
</html>
